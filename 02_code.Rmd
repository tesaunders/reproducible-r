---
title: "R Code"
---

## Writing better code

We can improve our scripts by writing code which is:

1. Readable

- Use a consistent style guide (like the tidyverse one)
- Be clear, concise, and consistent when naming objects, datasets, and functions
- Break your scripts up into sections (Ctrl+Shift+R)

2. Reusable

- Write functions to perform sets of operations
- Use iteration (for loops, or `map()`) 
- Consider creating packages for data and code used in multiple places
- Break up long scripts into separate files (cleaning, manipulating, plotting)

3. Documented

- Use comments to explain why you did something the way you did 
- Include a README with each project to provide important context and background

Create a new script in RStudio (Ctrl+Shift+N) and save it in the `scripts` folder.

Load packages we need for the workshop.

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(renv)
```

Let's take a common example of some data analysis and apply the above principles when writing the code.

First, let's read in some data split into different files by month. Instead of naming each file, we can use `readr::read_csv()` to read them all in at once, bind them together into a single dataframe, and add a new column containing the filename of the data source. 

```{r}
files <- list.files(path = "data_raw", pattern = "\\.csv", full.names = TRUE)

surveys <- read_csv(files, id = "source")
```

This dataset comprises measurements taken from mammals captured in the Chihuahuan desert. 

Let's say we wanted to create a separate scatterplot for each species showing hindfoot length vs weight. Even if we're only interested in species codes with at least 100 valid observations, that's still 11 plots. 
```{r}
valid_species <-
  surveys |>
  drop_na(all_of(c("weight", "hindfoot_length"))) |> 
  count(species_id) |> 
  filter(n >= 100) |> 
  pull(species_id)
```

Rather than write out the same code 15 times, this is a good time to write our own function. If we encapsulate all the plotting steps in a function, we can then use {purrr} to apply the function over the species and create the plots.

```{r}
# Create an example of a plot
ggplot(surveys, aes(x = weight, y = hindfoot_length, colour = sex)) +
  geom_point() +
  theme_minimal()
```

```{r}
plot_species <- function(data, x_var, y_var, colour, species) {

  filtered_data <- 
    data |> 
    filter(species_id == {{ species }})
  
  plot_title <- paste0(y_var, " vs. ", x_var, " for Species ID: ", species)
  
  plot <- 
    filtered_data |> 
    ggplot(aes(x = .data[[x_var]], y = .data[[y_var]], colour = .data[[colour]])) +
    geom_point(alpha = 0.6) +
    theme_minimal()
  
  save_path <- paste0("figures/", species, "_", x_var, "_vs_", y_var, ".png")
  
  ggsave(save_path, plot = plot, width = 10, height = 6, units = "in")
}

walk(valid_species, ~ plot_species(
  data = surveys,
  x_var = "weight",
  y_var = "hindfoot_length",
  colour = "sex",
  species = .x 
))
```




